---
# Add integration tests for issue https://github.com/ansible-collections/community.aws/issues/2131
- name: Test creation/deletion of launch template with more 200 versions
  vars:
    test_launch_template_name: "{{ resource_prefix }}-limits"
    test_total_versions: "{{ range(1, 205) }}"
  block:
    - name: Create a Launch template with more than 200 versions using
      community.aws.ec2_launch_template:
        name: "{{ test_launch_template_name }}"
        instance_type: t2.micro
        version_description: "Version number {{ item }}"
        source_version: 1
        default_version: 1
      with_items: "{{ test_total_versions }}"

    - name: Retrieve Launch template information
      amazon.aws.ec2_launch_template_info:
        filters:
          launch-template-name: "{{ test_launch_template_name }}"
      register: _templates

    - name: Ensure the Launch template was created as expected
      ansible.builtin.assert:
        that:
          - _templates.launch_templates | length == 1
          - _templates.launch_templates[0].versions | length == test_total_versions | length

    - name: Delete the launch template
      community.aws.ec2_launch_template:
        name: "{{ test_launch_template_name }}"
        state: absent
      register: _delete_templ

    - name: Retrieve Launch template information
      amazon.aws.ec2_launch_template_info:
        filters:
          launch-template-name: "{{ test_launch_template_name }}"
      register: _templates

    - name: Ensure the Launch template does not exist anymore
      ansible.builtin.assert:
        that:
          - _delete_templ is changed
          - _templates.launch_templates | length == 0

  always:
    - name: Delete launch template
      community.aws.ec2_launch_template:
        state: absent
        name: "{{ test_launch_template_name }}"
      ignore_errors: true
